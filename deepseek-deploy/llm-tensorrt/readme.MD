# TensorRT-LLM é›†ç¾¤é…ç½®è„šæœ¬

æ­¤è„šæœ¬ç”¨äºè‡ªåŠ¨åŒ–é…ç½®TensorRT-LLMçš„åˆ†å¸ƒå¼è®­ç»ƒå’Œæ¨ç†ç¯å¢ƒï¼ŒåŒ…æ‹¬Dockerå®¹å™¨å¯åŠ¨ã€SSHæœåŠ¡é…ç½®å’Œä¸»èŠ‚ç‚¹MPICHå®‰è£…ã€‚

å…³äºTensorrt-LLMï¼Œè¯·å‚çœ‹å®˜ç½‘[Tensorrt-LLM](https://nvidia.github.io/TensorRT-LLM/overview.html)

## cudaè¦æ±‚
```
å­˜å‚¨æ—§ç‰ˆæœ¬åˆ™éœ€è¦å¸è½½æ—§ç‰ˆcuda
sudo /usr/local/cuda-12.4/bin/cuda-uninstaller
sudo apt-get --purge remove "*nvidia*"
sudo apt-get autoremove
reboot ç³»ç»Ÿ

å®‰è£…æ–°ç‰ˆcuda
wget https://developer.download.nvidia.com/compute/cuda/12.8.1/local_installers/cuda_12.8.1_570.124.06_linux.run
sudo sh cuda_12.8.1_570.124.06_linux.run

apt install nvidia-cuda-toolkit

# nvidia-fabricmanager
sudo systemctl stop nvidia-fabricmanager
sudo systemctl disable nvidia-fabricmanager
dpkg --list | grep nvidia-fabricmanager
sudo apt remove nvidia-fabricmanager-550 (å¦‚æœå­˜åœ¨æ—§çš„å°±å¸è½½)

https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu2004/x86_64/nvidia-fabricmanager-570_570.124.06-1_amd64.deb
apt-get install ./nvidia-fabricmanager-570_570.124.06-1_amd64.deb -y
systemctl enable nvidia-fabricmanager
systemctl restart nvidia-fabricmanager
systemctl status nvidia-fabricmanager


# å®‰è£… NVIDIA Container Toolkit
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit
sudo systemctl restart docker    
```

## æ–‡ä»¶è¯´æ˜

- configuration ç›®å½•: é…ç½®æ–‡ä»¶,æ‰€æœ‰èŠ‚ç‚¹å‡éœ€è¦æœ‰ã€‚
  - hostfile: é›†ç¾¤å†…çš„èŠ‚ç‚¹ipåˆ—è¡¨ï¼Œå®¿ä¸»æœºçš„ipå³å¯ï¼Œè¯·ç¡®ä¿å„IPä¹‹é—´äº’é€šã€‚
- sshkey ç›®å½•: å…å¯†ç™»å½•ç”¨é€”,æ‰€æœ‰èŠ‚ç‚¹å‡éœ€è¦ã€‚
- `1-start-cluster-env.sh`: ç”¨äºé…ç½®é›†ç¾¤èŠ‚ç‚¹
- `1-stop-cluster-env.sh`: åœæ­¢æ•´ä¸ªé›†ç¾¤åŒ…æ‹¬é‡Œé¢çš„æ¨ç†æœåŠ¡
- `2-check-cluster-env.sh`: ç”¨äºæ£€æŸ¥å®¹å™¨ç¯å¢ƒçŠ¶æ€ï¼Œå¹¶è·å–èŠ‚ç‚¹IP
- `3-setup-node-config.sh`: ç”¨äºè®¾ç½®é…ç½®åˆ°nodeèŠ‚ç‚¹
- `4-start-trt-server.sh`: å¯åŠ¨æ¨ç†æœåŠ¡-ä»…ä¸»èŠ‚ç‚¹æ‰§è¡Œã€‚
- `env.example`: ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶

## ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶ï¼Œå¹¶æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š

```bash
cd llm-tensorrt
cp env.example .env
```

åœ¨`.env`æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š
- `DOCKER_IMAGE`: Dockeré•œåƒåç§°
- `SSH_PORT`: SSHæœåŠ¡ç«¯å£
- `SSHKEY_DIR`: SSHå¯†é’¥ç›®å½•ï¼ˆé»˜è®¤ä¸ºè„šæœ¬ç›®å½•ä¸‹çš„"sshkey"æ–‡ä»¶å¤¹ï¼Œå°†è¢«æŒ‚è½½åˆ°å®¹å™¨å†…çš„/root/.sshï¼‰
- `MODEL_REPO_DIR`: æ¨¡å‹ä»“åº“ç›®å½•ï¼ˆé»˜è®¤ä¸º"/mnt/share/deepseek-ai"ï¼‰
- `IS_MASTER`: æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹ï¼ˆä¸»èŠ‚ç‚¹ä¼šå®‰è£…MPICHï¼‰

### 2. å‡†å¤‡Dockeré•œåƒ

åœ¨è¿è¡Œè„šæœ¬å‰ï¼Œç¡®ä¿å·²ç»å‡†å¤‡å¥½æ‰€éœ€çš„Dockeré•œåƒã€‚å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–é•œåƒï¼š

```bash
# ä»Docker Hubæ‹‰å–é•œåƒ
docker pull baseten/tensorrt_llm-release:0.19.0rc0

# æˆ–è€…ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥é•œåƒ
docker load -i <é•œåƒæ–‡ä»¶è·¯å¾„>
å¦‚ï¼š
docker load < /modelshare_readonly/software/docker-images/tensorrt_llm/tensorrt_llm-release-0.19.0rc0.tar 
```

### 3. è¿è¡Œè„šæœ¬

ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼š

```bash
chmod +x 1-start-cluster-env.sh
```

ä»¥rootç”¨æˆ·è¿è¡Œè„šæœ¬ï¼š

```bash
sudo ./1-start-cluster-env.sh
```

### 4. ä¸»ä»èŠ‚ç‚¹é…ç½®
> å¦‚æœæ˜¯å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼Œåˆ™é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹å‡éœ€è¦æ‰§è¡Œè¯¥æ­¥éª¤ã€‚

- ä¸»èŠ‚ç‚¹: å°†`.env`æ–‡ä»¶ä¸­çš„`IS_MASTER`è®¾ç½®ä¸º`true`
- ä»èŠ‚ç‚¹: å°†`.env`æ–‡ä»¶ä¸­çš„`IS_MASTER`è®¾ç½®ä¸º`false`ï¼ˆé»˜è®¤ï¼‰

### 5. éªŒè¯é…ç½®

è„šæœ¬æ‰§è¡Œå®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```bash
sh 2-check-cluster-env.sh

-e 
-e ###############################################################################
-e #                                                                             #
-e #                                                                             #
-e #           TensorRT-LLM é›†ç¾¤éƒ¨ç½²å·¥å…·                                           #
-e #                                                                             #
-e #                                                                             #
-e ###############################################################################

-e [INFO] å¼€å§‹æ£€æŸ¥TensorRT-LLMé›†ç¾¤ç¯å¢ƒ...
-e [INFO] å½“å‰ç¯å¢ƒå˜é‡é…ç½®å¦‚ä¸‹ï¼š
-e   ğŸ› ï¸ DOCKER_IMAGE    = baseten/tensorrt_llm-release:0.19.0rc0
-e   ğŸ› ï¸ SSH_PORT        = 2233
-e   ğŸ› ï¸ IS_MASTER       = false
-e   ğŸ› ï¸ SSHKEY_DIR      = ./sshkey
-e   ğŸ› ï¸ MODEL_REPO_DIR  = /modelshare_readonly/deepseek-ai

-e [INFO] æ£€æŸ¥dsnodeå®¹å™¨æ˜¯å¦å­˜åœ¨å¹¶è¿è¡Œ...
-e [PASS] dsnodeå®¹å™¨æ­£åœ¨è¿è¡Œ
-e [INFO] æ£€æŸ¥SSHæœåŠ¡æ˜¯å¦æ­£å¸¸...
-e [PASS] SSHæœåŠ¡æ­£å¸¸ï¼Œç›‘å¬ç«¯å£ 2233
-e [INFO] æµ‹è¯•SSHå…å¯†è¿æ¥...
-e [PASS] SSHè¿æ¥æµ‹è¯•æˆåŠŸ
-e [INFO] æ£€æŸ¥GPUæ˜¯å¦å¯ç”¨...
Warning: Permanently added '[localhost]:2233' (ED25519) to the list of known hosts.
Warning: Permanently added '[localhost]:2233' (ED25519) to the list of known hosts.
-e [PASS] GPUå¯ç”¨ï¼Œå·²éªŒè¯nvidia-smiå¯ä»¥æ­£å¸¸è¿è¡Œ
-e [INFO] æ£€æŸ¥CUDAç‰ˆæœ¬å’Œé©±åŠ¨å…¼å®¹æ€§...
SSHè¿æ¥æµ‹è¯•æˆåŠŸ
SSH_TEST_OK
-e [PASS] CUDAç‰ˆæœ¬: 12.8, é©±åŠ¨ç‰ˆæœ¬: 570.124.06, å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡
-e [INFO] éä¸»èŠ‚ç‚¹ï¼Œè·³è¿‡MPICHæ£€æŸ¥
-e [INFO] æ£€æŸ¥æ¨¡å‹ä»“åº“ç›®å½•æŒ‚è½½...
-e [PASS] æ¨¡å‹ä»“åº“ç›®å½•å·²æ­£ç¡®æŒ‚è½½: /workspace
-e [INFO] /workspaceç›®å½•å†…å®¹:
  - DeepSeek-R1
  - DeepSeek-R1-Block-INT8
  - DeepSeek-R1-Channel-INT8
  - DeepSeek-R1-Distill-Llama-70B
  - DeepSeek-R1-Distill-Llama-8B
  - DeepSeek-R1-Distill-Qwen-1.5B
  - DeepSeek-R1-Distill-Qwen-14B
  - DeepSeek-R1-Distill-Qwen-32B
  - DeepSeek-R1-Distill-Qwen-7B
  - DeepSeek-R1-GGUF
  - DeepSeek-R1-bf16
  - DeepSeek-V3
  - DeepSeek-V3-0324
  - DeepSeek-V3-0324-Channel-INT8
  - DeepSeek-V3-0324-bf16
  - DeepSeek-V3-Channel-INT8
  - DeepSeek-V3-bf16


-e [INFO] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-e [INFO] âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆï¼šæ‰€æœ‰æ£€æŸ¥é€šè¿‡
-e [INFO]   å®¹å™¨åç§°: dsnode
-e [INFO]   å®¹å™¨IPåœ°å€: -e [INFO] è·å–dsnodeå®¹å™¨IPåœ°å€...
-e [WARNING] æ— æ³•è·å–dsnodeå®¹å™¨çš„IPåœ°å€ï¼Œå°è¯•ä½¿ç”¨å®¿ä¸»æœºIP
-e [INFO] å®¹å™¨IPåœ°å€: 10.83.0.103
-e [INFO] å®¿ä¸»æœºIPåœ°å€: 10.83.0.103
10.83.0.103
-e [INFO]   å®¿ä¸»æœºIPåœ°å€: 10.83.0.103
-e [INFO]   SSHç«¯å£: 2233
-e [INFO] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 5. ä¿®æ”¹é…ç½®å¹¶ä¸Šä¼  
> å¦‚æœæ˜¯å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼Œåˆ™é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹å‡éœ€è¦æ‰§è¡Œè¯¥æ­¥éª¤ã€‚

```
æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹configurationæ–‡ä»¶å¤¹çš„é…ç½®,ä¸»è¦è®¾ç½®configurationä¸­çš„hostfileã€‚å…¶ä»–çš„å¦‚extra-llm-api-config.ymlåˆ™æ ¹æ®å®é™…éœ€è¦ä¿®æ”¹ã€‚

ç„¶åæ‰§è¡Œ sh 3-setup-node-config.sh ä¿å­˜ã€‚
```

### 6. å¯åŠ¨æ¨ç†æœåŠ¡
> è¯¥æ­¥éª¤åœ¨ä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯ã€‚
> å…ˆç¡®ä¿é›†ç¾¤å†…æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½åŠ å…¥åˆ°äº†configurationä¸­çš„hostfileä¸­ã€‚


æ‰§è¡Œ sh 4-start-trt-server.sh -f å¯åŠ¨æ¨ç†æœåŠ¡ã€‚

å¯åŠ¨å®Œæˆåï¼Œä¼šæœ‰å¦‚ä¸‹æ—¥å¿—ï¼š
```
INFO:     Started server process [8924]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8888 (Press CTRL+C to quit)
```

#### å‘½ä»¤ä½¿ç”¨å¸®åŠ©
```
-e [INFO] å·²ä»/root/llm-tensorrtllm/llm-tensorrt/.envåŠ è½½ç¯å¢ƒå˜é‡
-e ç”¨æ³•: 4-start-trt-server.sh [é€‰é¡¹]

-e é€‰é¡¹:
-e   -h, --help             æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
-e   -s, --stop             åœæ­¢æ­£åœ¨è¿è¡Œçš„TensorRT-LLMæœåŠ¡
-e   -r, --restart          é‡å¯TensorRT-LLMæœåŠ¡
-e   -b, --background       åœ¨åå°è¿è¡ŒæœåŠ¡ (ç­‰åŒäºè®¾ç½® RUN_IN_BACKGROUND=true)
-e   -f, --follow-logs      åœ¨åå°è¿è¡ŒæœåŠ¡å¹¶è‡ªåŠ¨æ˜¾ç¤ºæ—¥å¿—
-e   --logs                 æ˜¾ç¤ºå½“å‰è¿è¡ŒæœåŠ¡çš„æ—¥å¿—
-e   --clean-zombies        æ¸…ç†åƒµå°¸è¿›ç¨‹
-e   --status               æ˜¾ç¤ºå½“å‰æœåŠ¡çŠ¶æ€åŠè¿›ç¨‹ä¿¡æ¯

-e ç¤ºä¾‹:
-e   4-start-trt-server.sh                     åœ¨å‰å°å¯åŠ¨æœåŠ¡ (æŒ‰Ctrl+Cåœæ­¢)
-e   4-start-trt-server.sh -b                  åœ¨åå°å¯åŠ¨æœåŠ¡
-e   4-start-trt-server.sh -f                  åœ¨åå°å¯åŠ¨æœåŠ¡å¹¶è‡ªåŠ¨æ˜¾ç¤ºæ—¥å¿—
-e   4-start-trt-server.sh --logs              æ˜¾ç¤ºå½“å‰è¿è¡ŒæœåŠ¡çš„æ—¥å¿—
-e   4-start-trt-server.sh --status            æ£€æŸ¥æœåŠ¡çŠ¶æ€
```


## æ³¨æ„äº‹é¡¹

1. è„šæœ¬éœ€è¦ä»¥rootç”¨æˆ·æƒé™è¿è¡Œ
2. ç¡®ä¿å·²å®‰è£…Docker
3. ç¡®ä¿Dockerå¯ä»¥è®¿é—®GPUï¼ˆéœ€è¦å®‰è£…nvidia-dockerï¼‰
4. å¦‚æœå®¹å™¨å·²å­˜åœ¨ï¼Œè„šæœ¬ä¼šè¯¢é—®æ˜¯å¦åˆ é™¤ç°æœ‰å®¹å™¨
5. å¦‚æœæ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œè¯·ç¡®ä¿SSHåˆ°æœåŠ¡å™¨åå†æ‰§è¡Œè¿™äº›å‘½ä»¤
6. è„šæœ¬ä¼šæ£€æŸ¥æ‰€éœ€çš„Dockeré•œåƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°†é€€å‡ºå¹¶æç¤ºå¯¼å…¥é•œåƒ

## å¸¸è§é—®é¢˜

### å®¹å™¨é—´SSHèƒ½é€š,ä½†æ˜¯MIPRUNä¸é€š
```
 sudo iptables -L -v -n  æŸ¥çœ‹é˜²ç«å¢™ç­–ç•¥

 Chain DOCKER (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   54  3240 ACCEPT     tcp  --  !docker0 docker0  0.0.0.0/0            172.17.0.2           tcp dpt:40000
    0     0 ACCEPT     tcp  --  !docker0 docker0  0.0.0.0/0            172.17.0.2           tcp dpt:2233
    ğŸˆ²0     0 DROP       all  --  !docker0 docker0  0.0.0.0/0            0.0.0.0/0   

è¿™ä¸ªdropç­–ç•¥å¯¼è‡´å®¹å™¨é—´çš„é€šè®¯é—®é¢˜ï¼ŒæŠŠè¿™ä¸ªè§„åˆ™dropæ‰
    

 æµ‹è¯•
mpirun -np 3 --hostfile /hostfile \
  -mca oob_tcp_if_include bond0 \
  -mca btl_tcp_if_include bond0 \
  --mca btl_base_verbose 10 \
  --allow-run-as-root \
  hostname
```